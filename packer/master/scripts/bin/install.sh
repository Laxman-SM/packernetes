#!/usr/bin/env bash
#./install.sh

if [[ "" == "$TOKEN" ]]; then
  export TOKEN="$(kubeadm token generate)"

  echo "WARNING"
  echo "WARNING you did not provide a token in the environment variable TOKEN"
  echo "WARNING"
  echo "WARNING we will now use an autogenerated token: [[$TOKEN]]"
  echo "WARNING"
fi

if [[ "" == "$FQDN" ]]; then
  APISERVER_CERT_EXTRA_SANS=""
else
  APISERVER_CERT_EXTRA_SANS="--apiserver-cert-extra-sans=$FQDN"
fi

set -e

sudo kubeadm init \
  --token="$TOKEN" \
  --pod-network-cidr="10.244.0.0/16" $APISERVER_CERT_EXTRA_SANS

mkdir -pv /home/ubuntu/kubernetes

sudo cat /etc/kubernetes/admin.conf | \
  tee /home/ubuntu/kubernetes/admin.conf

exit 0

